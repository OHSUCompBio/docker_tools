'''
Created on Aug. 24, 2022

@author: pleyte
'''

from _collections import defaultdict
import csv
import logging

from edu.ohsu.compbio.txeff.variant_transcript import VariantTranscript


class TxEffCcds(object):
    '''
    This class adds CCDS accessions to the transcript effects 
    '''
    def __init__(self, refseq_to_ccds_file):
        '''
        refseq_to_ccds_file is the path to a file that contains mappings from RefSeq id to CCDS id. The file can either 
        be the NCBI GFF (eg https://ftp.ncbi.nlm.nih.gov/refseq/H_sapiens/annotation/GRCh37_latest/refseq_identifiers/GRCh37_latest_genomic.gff.gz) 
        or the csv file generated by ``tx_eff_csv.py``  
        '''
        # Save the filename for later 
        self.refseq_to_ccds_file = refseq_to_ccds_file
        
        # Set up a logger for this class
        self.logger = logging.getLogger(__name__)

    def _get_refseq_to_ccds_mappings(self):
        '''
        Return a dictionary of RefSeq id to CCDS id. The mappings are read from a CSV file that was created by 
        the script: https://github.com/ohsu-comp-bio/kdl-tools/tree/master/cgd_prep/src/edu/ohsu/compbio/etl/refseq_ccds.py
        '''
        refseq_ccds_map = defaultdict()
        
        with open(self.refseq_to_ccds_file) as csv_file:
            reader = csv.DictReader(csv_file)
            for row in reader:
                if refseq_ccds_map.get(row['refseq_id']) is not None:
                    raise Exception(f"RefSeq id {row['refseq_id']} is already mapped to {refseq_ccds_map.get(row['refseq_id'])}. Cannot add additional mapping to {row['ccds_id']}")
                
                refseq_ccds_map[row['refseq_id']] = row['ccds_id']
        
        self.logger.info(f"Created RefSeq-CCDS map of size {len(refseq_ccds_map)} from CSV")
        
        return refseq_ccds_map

    def _get_preferred_refseq_transcript(self, transcript0: VariantTranscript, transcript1: VariantTranscript):
        '''
        When a CCDS transcript is mapped to multiple RefSeq transcripts then we need to choose just one RefSeq. The one
        we choose is the earliest because it is assumed to be the best curated.  So NM_111.5 is preferred over
        'NM_222.4'.  
        ''' 
        if(not transcript0.refseq_transcript.startswith('NM_') or not transcript1.refseq_transcript.startswith('NM_')):
            raise ValueError(f'Both transcripts should have a RefSeq accession starting with "NM_": {transcript0.refseq_transcript}, {transcript1.refseq_transcript}')
        
        # If the the transcripts are the same then it doesn't matter which one is returned 
        if transcript0.refseq_transcript == transcript1.refseq_transcript:
            return transcript0
        
        t0_accession, t0_version = map(int, transcript0.refseq_transcript.replace('NM_', '').split('.'))
        t1_accession, t1_version = map(int, transcript1.refseq_transcript.replace('NM_', '').split('.'))

        if(t0_accession == t1_accession):
            if(t0_version > t1_version):
                return transcript0
            else:
                return transcript1
        elif(t0_accession < t1_accession):
            return transcript0
        else:
            return transcript1

    def _get_ccds_mapped_transcripts(self, refseq_transcripts: list):
        '''
        Return a map where the key is a CCDS accession and the value is a VariantTranscript whose 'refseq_transcript'
        is the RefSeq accession that is mapped to the CCDS key. Any transcripts in the 'refseq_transcripts' parameter
        that cannot be mapped to a CCDS accession will not be in the returned map.
        '''
        # Load the refseq to CCDS map from file        
        refseq_to_ccds_mappings = self._get_refseq_to_ccds_mappings()        
        if(len(refseq_to_ccds_mappings) == 0):
            raise Exception(f"No mappings found in input file {self.refseq_to_ccds_file}") 

        ccds_to_transcript = {}
        cnt_mapped_to_ccds = 0
        cnt_not_mapped_to_ccds = 0 

        for variant_transcript in refseq_transcripts:
            refseq_id = variant_transcript.refseq_transcript
            ccds_id = refseq_to_ccds_mappings.get(refseq_id)
            
            if ccds_id:
                cnt_mapped_to_ccds = cnt_mapped_to_ccds + 1
                existing_transcript = ccds_to_transcript.get(ccds_id)
                if existing_transcript:
                    # A refseq accession has already been mapped to this ccds but there can only be one, so make a choice.
                    preferred_transcript = self._get_preferred_refseq_transcript(variant_transcript, existing_transcript)
                    ccds_to_transcript[ccds_id] = preferred_transcript
                    self.logger.debug(f'RefSeq {variant_transcript.refseq_transcript} and {existing_transcript.refseq_transcript} both map to {ccds_id}. {preferred_transcript.refseq_transcript} is preferred.')
                else:
                    # Put the new mapping in the dictionary 
                    ccds_to_transcript[ccds_id] = variant_transcript
            else:
                cnt_not_mapped_to_ccds = cnt_not_mapped_to_ccds + 1
                self.logger.debug(f"Unable to find CCDS id mapping for {refseq_id}")

        self.logger.info(f"Mapped {cnt_mapped_to_ccds} RefSeq accessions to CCDS.")
        if(cnt_not_mapped_to_ccds > 0):
            self.logger.info(f"Could not find mappings for {cnt_not_mapped_to_ccds} refseq ids.")

        return ccds_to_transcript
    
    def _get_ccds_transcripts(self, refseq_transcripts: list):
        '''
        Take a list of variant transcripts that have refseq accessions and see if any of them are mapped to 
        CCDS accessions. For every variant-transcript whose refseq can be mapped to ccds, create a copy of it, 
        and change the transcript identifier to the ccds accession. 
        '''
        ccds_transcripts = []
        
        # Get a map of refseq transcripts that can be mapped to a ccds accession
        ccds_to_transcript = self._get_ccds_mapped_transcripts(refseq_transcripts)
        
        # For each transcript make a copy and substitute the refseq accession with the ccds 
        for ccds_id, refseq_transcript in ccds_to_transcript.items():
            ccds_transcript = refseq_transcript.get_copy()
            ccds_transcript.refseq_transcript = ccds_id
            ccds_transcripts.append(ccds_transcript)
        
        return ccds_transcripts

    def add_ccds_transcripts(self, refseq_transcripts: list):
        '''
        Iterate over the list of RefSeq transcripts, lookup each refseq id in the Refseq-to-CCDS id map, and create a copy of the transcript.  
        '''
        # Create copies of every refseq transcript that has an accession that is mapped to a CCDS accession. 
        ccds_transcripts = self._get_ccds_transcripts(refseq_transcripts)
        
        # Add the CCDS transcripts to the list
        refseq_transcripts.extend(ccds_transcripts)
        
        return refseq_transcripts
